{% extends "base.html" %}

{% block extra_css %}
<style>
    .progress-container {
        margin-bottom: 2em;
    }
    
    .progress-bar-container {
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        margin: 1em 0;
        overflow: hidden;
    }
    
    .progress-bar {
        height: 100%;
        background-color: #4acaa8; /* Match the theme color */
        border-radius: 10px;
        transition: width 0.3s ease;
    }
    
    .progress-text {
        font-size: 0.9em;
        color: #555;
        margin-bottom: 1em;
    }
    
    .live-results, .live-errors {
        margin-top: 1em;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #eee;
        padding: 0.5em 1em;
        border-radius: 5px;
    }
    
    .live-errors {
        background-color: #fff0f0;
    }
    
    .success-list li, .error-list li {
        margin-bottom: 0.5em;
        font-size: 0.9em;
    }
    
    .error-list li {
        color: #cc0000;
    }
</style>
{% endblock %}

{% block body_class %}is-preload{% endblock %}

{% block hero %}
<section id="hero" class="container">
    <header>
        <h2>Company Research</h2>
    </header>
    <p>Select a company, category, and prompt to begin your research</p>
</section>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-4 col-12-narrower">
        <section>
            <header>
                <h3>Research Parameters</h3>
            </header>
            <form id="research-form">
                <div class="row gtr-50">
                    <div class="col-12">
                        <label for="company">Company</label>
                        <select name="company" id="company">
                            {% for company in companies %}
                            <option value="{{ company }}">{{ company }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <label for="prompt-category">Category</label>
                        <select name="prompt_category" id="prompt-category">
                            {% for category_name, categories in prompt_categories.items() %}
                            <option value="{{ category_name }}">{{ category_name.replace('_', ' ') }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <label for="subcategory">Subcategory</label>
                        <select name="subcategory" id="subcategory">
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="col-12">
                        <label for="prompt-number">Prompt</label>
                        <select name="prompt_number" id="prompt-number">
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="col-12">
                        <div class="row">
                            <div class="col-4">
                                <button type="submit" class="button">Research</button>
                            </div>
                            <div class="col-4">
                                <button type="button" id="research-all-btn" class="button alt">Research All</button>
                            </div>
                            <div class="col-4">
                                <button type="button" id="research-all-companies-btn" class="button alt">Research All Companies</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </section>
        
        <section id="research-history">
            <header>
                <h3>Research History</h3>
            </header>
            <div id="history-list">
                <!-- Will be populated by JavaScript -->
                <p>No research conducted yet.</p>
            </div>
            <div class="export-actions" style="display: none;">
                <h4>Export Options</h4>
                <div class="row gtr-50">
                    <!-- <div class="col-6">
                        <button id="export-json-btn" class="button small">JSON</button>
                    </div> -->
                    <div class="col-6">
                        <button id="export-word-btn" class="button small">Word</button>
                    </div>
                    <div class="col-6">
                        <button id="export-pdf-btn" class="button small">PDF</button>
                    </div>
                    <div class="col-6">
                        <button id="export-excel-btn" class="button small">Excel</button>
                    </div>
                    <div class="col-12">
                        <button id="export-pptx-btn" class="button small">PowerPoint</button>
                    </div>
                </div>
            </div>
        </section>
    </div>
    
    <div class="col-8 col-12-narrower">
        <section id="research-results">
            <header>
                <h3>Research Results</h3>
            </header>
            <div id="results-container">
                <div class="placeholder">
                    <p>Select a company, category, and prompt to begin your research.</p>
                </div>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Store prompt categories data
    const promptCategories = JSON.parse('{{ prompt_categories|tojson|safe }}');
    let researchHistory = {};
    
    // Function to update subcategories based on selected category
    function updateSubcategories() {
        const category = document.getElementById('prompt-category').value;
        const subcategorySelect = document.getElementById('subcategory');
        
        // Clear existing options
        subcategorySelect.innerHTML = '';
        
        // Add new options
        if (promptCategories[category]) {
            Object.keys(promptCategories[category]).forEach(subcategory => {
                const option = document.createElement('option');
                option.value = subcategory;
                option.textContent = subcategory;
                subcategorySelect.appendChild(option);
            });
            
            // Trigger update of prompts
            updatePrompts();
        }
    }
    
    // Function to update prompts based on selected subcategory
    function updatePrompts() {
        const category = document.getElementById('prompt-category').value;
        const subcategory = document.getElementById('subcategory').value;
        const promptSelect = document.getElementById('prompt-number');
        
        // Clear existing options
        promptSelect.innerHTML = '';
        
        // Add new options
        if (promptCategories[category] && promptCategories[category][subcategory]) {
            promptCategories[category][subcategory].forEach(prompt => {
                const option = document.createElement('option');
                option.value = prompt.number;
                option.textContent = `${prompt.number}. ${prompt.text.substring(0, 50)}...`;
                promptSelect.appendChild(option);
            });
        }
    }
    
    // Initialize form
    document.addEventListener('DOMContentLoaded', function() {
        // Set up event listeners
        document.getElementById('prompt-category').addEventListener('change', updateSubcategories);
        document.getElementById('subcategory').addEventListener('change', updatePrompts);
        
        // Initialize subcategories
        updateSubcategories();
        
        // Handle form submission
        document.getElementById('research-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const company = document.getElementById('company').value;
            const promptCategory = document.getElementById('prompt-category').value;
            const subcategory = document.getElementById('subcategory').value;
            const promptNumber = document.getElementById('prompt-number').value;
            
            // Show loading state
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.innerHTML = '<div class="loading"><p>Researching... This may take a moment.</p></div>';
            
            try {
                // Make API request
                const formData = new FormData();
                formData.append('company', company);
                formData.append('prompt_category', promptCategory);
                formData.append('subcategory', subcategory);
                formData.append('prompt_number', promptNumber);
                
                const response = await fetch('/conduct_research', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    // If the server returned an error response with details
                    throw { 
                        message: data.error || 'Research failed', 
                        details: data.details || '',
                        response: response 
                    };
                }
                
                if (data.error) {
                    // Handle case where server returns 200 but with an error property
                    throw { 
                        message: data.error, 
                        details: data.details || '',
                        response: response 
                    };
                }
                
                // Update research history
                if (!researchHistory[company]) {
                    researchHistory[company] = [];
                }
                
                const historyItem = {
                    company,
                    promptCategory,
                    subcategory,
                    promptNumber: parseInt(promptNumber),
                    prompt: data.prompt,
                    result: data.result,
                    sources: data.sources,
                    timestamp: new Date().toISOString()
                };
                
                researchHistory[company].push(historyItem);
                updateHistoryList();
                
                // Display results
                displayResults(data);
                
                // Show export button
                document.querySelector('.export-actions').style.display = 'block';
                
            } catch (error) {
                console.error('Error:', error);
                let errorMessage = 'An error occurred while conducting research. Please try again.';
                let errorDetails = '';
                
                // Try to parse the error response if it's a JSON
                if (error.response) {
                    try {
                        const errorData = await error.response.json();
                        if (errorData.error) {
                            errorMessage = errorData.error;
                        }
                        if (errorData.details) {
                            errorDetails = errorData.details;
                        }
                    } catch (e) {
                        // If we can't parse the JSON, use the error message
                        errorDetails = error.message || 'Unknown error';
                    }
                } else {
                    errorDetails = error.message || 'Unknown error';
                }
                
                resultsContainer.innerHTML = `
                    <div class="error" style="background-color: #ffeeee; padding: 15px; border-radius: 5px; border: 1px solid #ffcccc;">
                        <h4 style="color: #cc0000;">Research failed</h4>
                        <p>${errorMessage}</p>
                        ${errorDetails ? `<p class="error-details" style="font-family: monospace; background: #f8f8f8; padding: 10px; border-left: 3px solid #cc0000;">${errorDetails}</p>` : ''}
                        <p>Please check your API key and try again. If the problem persists, try using a different API provider.</p>
                    </div>
                `;
            }
        });
        
        // Handle Research All button
        document.getElementById('research-all-btn').addEventListener('click', async function() {
            const company = document.getElementById('company').value;
            
            // Confirm with the user
            if (!confirm(`This will research ALL prompts for ${company}. This may take a while and consume a significant amount of API credits. Continue?`)) {
                return;
            }
            
            // Show loading state
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.innerHTML = '<div class="loading"><p>Researching all prompts... This may take several minutes. Please do not close this page.</p></div>';
            
            try {
                // Make API request
                const formData = new FormData();
                formData.append('company', company);
                
                // Create a progress container
                const progressContainer = document.createElement('div');
                progressContainer.className = 'progress-container';
                progressContainer.innerHTML = `
                    <h4>Research Progress for ${company}</h4>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: 0%;"></div>
                    </div>
                    <p class="progress-text">Starting research...</p>
                    <div class="live-results">
                        <h5>Live Results:</h5>
                        <ul class="success-list"></ul>
                    </div>
                    <div class="live-errors" style="display: none;">
                        <h5>Errors:</h5>
                        <ul class="error-list"></ul>
                    </div>
                `;
                resultsContainer.innerHTML = '';
                resultsContainer.appendChild(progressContainer);
                
                // Set a longer timeout for the Research All request
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 600000); // 10-minute timeout
                
                const response = await fetch('/conduct_research_all', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw { 
                        message: 'Research failed', 
                        details: 'Server returned an error response',
                        response: response 
                    };
                }
                
                // Process the streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let finalData = null;
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) {
                        break;
                    }
                    
                    // Decode the chunk and add to buffer
                    buffer += decoder.decode(value, { stream: true });
                    
                    // Process complete lines in the buffer
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Keep the last incomplete line in the buffer
                    
                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        
                        try {
                            const eventData = JSON.parse(line);
                            
                            // Handle different event types
                            if (eventData.type === 'progress') {
                                // Update progress bar
                                const progressBar = progressContainer.querySelector('.progress-bar');
                                progressBar.style.width = `${eventData.percent}%`;
                                
                                // Update progress text
                                const progressText = progressContainer.querySelector('.progress-text');
                                progressText.textContent = eventData.message;
                                
                                // Add new results to the live results list
                                if (eventData.batch_results) {
                                    const successList = progressContainer.querySelector('.success-list');
                                    const errorList = progressContainer.querySelector('.error-list');
                                    
                                    // Add successes
                                    eventData.batch_results.successes.forEach(success => {
                                        const li = document.createElement('li');
                                        li.innerHTML = `<strong>${success.category} - ${success.subcategory}</strong>: Prompt #${success.prompt_number}`;
                                        successList.appendChild(li);
                                    });
                                    
                                    // Add errors
                                    if (eventData.batch_results.errors.length > 0) {
                                        progressContainer.querySelector('.live-errors').style.display = 'block';
                                        eventData.batch_results.errors.forEach(error => {
                                            const li = document.createElement('li');
                                            li.innerHTML = `<strong>${error.category} - ${error.subcategory}</strong>: Prompt #${error.prompt_number} - ${error.error}`;
                                            errorList.appendChild(li);
                                        });
                                    }
                                }
                            } else if (eventData.type === 'error') {
                                throw { 
                                    message: eventData.error, 
                                    details: eventData.details || ''
                                };
                            } else if (eventData.type === 'complete') {
                                // Store the final data for processing after the stream ends
                                finalData = eventData;
                            }
                        } catch (parseError) {
                            console.error('Error parsing event data:', parseError, line);
                        }
                    }
                }
                
                // Process the final data
                if (!finalData) {
                    throw {
                        message: 'Research incomplete',
                        details: 'The server did not send complete data'
                    };
                }
                
                const data = finalData;
                
                // Process and store the results in the frontend research history
                if (!researchHistory[company]) {
                    researchHistory[company] = [];
                }
                
                // Add all successful research results to the frontend history
                data.results.forEach(result => {
                    // Check if this result already exists in the history
                    const existingIndex = researchHistory[company].findIndex(item => 
                        item.category === result.category && 
                        item.subcategory === result.subcategory && 
                        item.prompt === result.prompt
                    );
                    
                    if (existingIndex >= 0) {
                        // Update existing entry
                        researchHistory[company][existingIndex] = {
                            prompt: result.prompt,
                            result: result.result,
                            sources: result.sources,
                            category: result.category,
                            subcategory: result.subcategory,
                            promptCategory: result.category,
                            promptNumber: result.prompt_number
                        };
                    } else {
                        // Add new entry
                        researchHistory[company].push({
                            prompt: result.prompt,
                            result: result.result,
                            sources: result.sources,
                            category: result.category,
                            subcategory: result.subcategory,
                            promptCategory: result.category,
                            promptNumber: result.prompt_number
                        });
                    }
                });
                
                // Sync the updated history with the backend
                syncResearchHistory(company);
                
                // Update history list in the UI
                updateHistoryList();
                
                // Display summary results
                resultsContainer.innerHTML = `
                    <div class="result">
                        <h4>Research Complete for ${company}</h4>
                        <p>Successfully completed ${data.total_successful} research items.</p>
                        ${data.total_errors > 0 ? `<p>Encountered ${data.total_errors} errors during research.</p>` : ''}
                        <h5>Research Summary:</h5>
                        <ul>
                            ${data.results.map(result => `
                                <li>
                                    <strong>${result.category} - ${result.subcategory}</strong>: 
                                    Prompt #${result.prompt_number}
                                </li>
                            `).join('')}
                        </ul>
                        ${data.errors.length > 0 ? `
                            <h5>Errors:</h5>
                            <ul>
                                ${data.errors.map(error => `
                                    <li>
                                        <strong>${error.category} - ${error.subcategory}</strong>: 
                                        Prompt #${error.prompt_number} - ${error.error}
                                    </li>
                                `).join('')}
                            </ul>
                        ` : ''}
                    </div>
                `;
                
                // Show export button
                document.querySelector('.export-actions').style.display = 'block';
                
            } catch (error) {
                console.error('Error:', error);
                let errorMessage = 'An error occurred while conducting research. Please try again.';
                let errorDetails = '';
                
                // Check for specific error types
                if (error.name === 'AbortError') {
                    errorMessage = 'The request timed out after 10 minutes.';
                    errorDetails = 'The server might still be processing your request in the background. Check the research history later to see if any results were saved.';
                } 
                else if (error.message && (error.message.includes('NetworkError') || error.message.includes('network'))) {
                    errorMessage = 'NetworkError when attempting to fetch resource.';
                    errorDetails = 'Please check your internet connection and try again. The server might still be processing your request in the background.';
                }
                else if (error.response) {
                    try {
                        const errorData = await error.response.json();
                        if (errorData.error) {
                            errorMessage = errorData.error;
                        }
                        if (errorData.details) {
                            errorDetails = errorData.details;
                        }
                    } catch (e) {
                        errorDetails = error.message || 'Unknown error';
                    }
                } else {
                    errorDetails = error.message || 'Unknown error';
                }
                
                // Attempt to sync research history in case some results were saved
                try {
                    const company = document.getElementById('company').value;
                    syncResearchHistory(company);
                    updateHistoryList();
                } catch (syncError) {
                    console.error('Error syncing research history:', syncError);
                }
                
                resultsContainer.innerHTML = `
                    <div class="error" style="background-color: #ffeeee; padding: 15px; border-radius: 5px; border: 1px solid #ffcccc;">
                        <h4 style="color: #cc0000;">Research All failed</h4>
                        <p>${errorMessage}</p>
                        ${errorDetails ? `<p class="error-details" style="font-family: monospace; background: #f8f8f8; padding: 10px; border-left: 3px solid #cc0000;">${errorDetails}</p>` : ''}
                        <p>Please check your API key and try again.</p>
                    </div>
                `;
            }
        });
        
        // Handle export buttons
        // JSON button is commented out in the HTML
        // document.getElementById('export-json-btn').addEventListener('click', function() {
        //     exportResults('json');
        // });
        
        document.getElementById('export-word-btn').addEventListener('click', async function() {
            await exportResults('word');
        });
        
        document.getElementById('export-pdf-btn').addEventListener('click', async function() {
            await exportResults('pdf');
        });
        
        document.getElementById('export-excel-btn').addEventListener('click', async function() {
            await exportResults('excel');
        });
        
        document.getElementById('export-pptx-btn').addEventListener('click', async function() {
            await exportResults('pptx');
        });
        
        // Handle Research All Companies button
        document.getElementById('research-all-companies-btn').addEventListener('click', async function() {
            // Confirm with the user
            if (!confirm(`This will research ALL prompts for ALL companies and export results to Word, PowerPoint, Excel, and PDF formats. This may take a long time and consume a significant amount of API credits. Continue?`)) {
                return;
            }
            
            // Get all companies
            const companySelect = document.getElementById('company');
            const companies = Array.from(companySelect.options).map(option => option.value);
            
            // Show loading state
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.innerHTML = '<div class="loading"><p>Researching all companies... This may take a long time. Please do not close this page.</p></div>';
            
            // Create a progress container
            const progressContainer = document.createElement('div');
            progressContainer.className = 'progress-container';
            progressContainer.innerHTML = `
                <h4>Research Progress for All Companies</h4>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: 0%;"></div>
                </div>
                <p class="progress-text">Starting research...</p>
                <div class="company-progress">
                    <h5>Company Progress:</h5>
                    <ul class="company-list"></ul>
                </div>
                <div class="live-results">
                    <h5>Live Results:</h5>
                    <ul class="success-list"></ul>
                </div>
                <div class="live-errors" style="display: none;">
                    <h5>Errors:</h5>
                    <ul class="error-list"></ul>
                </div>
            `;
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(progressContainer);
            
            // Track overall progress
            let totalCompanies = companies.length;
            let completedCompanies = 0;
            let overallSuccesses = 0;
            let overallErrors = 0;
            let companyResults = {};
            
            // Process each company sequentially
            for (const company of companies) {
                // Update progress text
                const progressText = progressContainer.querySelector('.progress-text');
                progressText.textContent = `Processing company ${completedCompanies + 1} of ${totalCompanies}: ${company}`;
                
                // Add company to the list with its own progress bar
                const companyList = progressContainer.querySelector('.company-list');
                const companyItem = document.createElement('li');
                companyItem.innerHTML = `
                    <strong>${company}</strong>: <span class="status">In progress...</span>
                    <div class="company-progress-bar-container" style="margin-top: 5px; height: 10px; background-color: #f0f0f0; border-radius: 5px; overflow: hidden;">
                        <div class="company-progress-bar" style="width: 0%; height: 100%; background-color: #4caf50;"></div>
                    </div>
                `;
                companyList.appendChild(companyItem);
                
                // Clear research history for this company to start fresh
                if (researchHistory[company]) {
                    console.log(`Clearing research history for ${company} before starting new research`);
                    researchHistory[company] = [];
                }
                
                try {
                    // Make API request for this company
                    const formData = new FormData();
                    formData.append('company', company);
                    
                    // Set a longer timeout for the Research All request
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 600000); // 10-minute timeout
                    
                    const response = await fetch('/conduct_research_all', {
                        method: 'POST',
                        body: formData,
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw { 
                            message: 'Research failed', 
                            details: 'Server returned an error response',
                            response: response 
                        };
                    }
                    
                    // Process the streaming response
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    let finalData = null;
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        
                        if (done) {
                            break;
                        }
                        
                        // Decode the chunk and add to buffer
                        buffer += decoder.decode(value, { stream: true });
                        
                        // Process complete lines in the buffer
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // Keep the last incomplete line in the buffer
                        
                        for (const line of lines) {
                            if (line.trim() === '') continue;
                            
                            try {
                                const eventData = JSON.parse(line);
                                
                                // Handle different event types
                                if (eventData.type === 'progress') {
                                    // Update company-specific progress bar
                                    const companyProgressBar = companyItem.querySelector('.company-progress-bar');
                                    if (companyProgressBar && eventData.percent) {
                                        companyProgressBar.style.width = `${eventData.percent}%`;
                                    }
                                    
                                    // Add new results to the live results list
                                    if (eventData.batch_results) {
                                        const successList = progressContainer.querySelector('.success-list');
                                        const errorList = progressContainer.querySelector('.error-list');
                                        
                                        // Add successes
                                        eventData.batch_results.successes.forEach(success => {
                                            const li = document.createElement('li');
                                            li.innerHTML = `<strong>${company}: ${success.category} - ${success.subcategory}</strong>: Prompt #${success.prompt_number}`;
                                            successList.appendChild(li);
                                        });
                                        
                                        // Add errors
                                        if (eventData.batch_results.errors.length > 0) {
                                            progressContainer.querySelector('.live-errors').style.display = 'block';
                                            eventData.batch_results.errors.forEach(error => {
                                                const li = document.createElement('li');
                                                li.innerHTML = `<strong>${company}: ${error.category} - ${error.subcategory}</strong>: Prompt #${error.prompt_number} - ${error.error}`;
                                                errorList.appendChild(li);
                                            });
                                        }
                                    }
                                } else if (eventData.type === 'error') {
                                    throw { 
                                        message: eventData.error, 
                                        details: eventData.details || ''
                                    };
                                } else if (eventData.type === 'complete') {
                                    // Store the final data for processing after the stream ends
                                    finalData = eventData;
                                    
                                    // Set company progress bar to 100%
                                    const companyProgressBar = companyItem.querySelector('.company-progress-bar');
                                    if (companyProgressBar) {
                                        companyProgressBar.style.width = '100%';
                                    }
                                }
                            } catch (parseError) {
                                console.error('Error parsing event data:', parseError, line);
                            }
                        }
                    }
                    
                    // Process the final data
                    if (!finalData) {
                        throw {
                            message: 'Research incomplete',
                            details: 'The server did not send complete data'
                        };
                    }
                    
                    const data = finalData;
                    
                    // Process and store the results in the frontend research history
                    if (!researchHistory[company]) {
                        researchHistory[company] = [];
                    }
                    
                    // Add all successful research results to the frontend history
                    data.results.forEach(result => {
                        // Check if this result already exists in the history
                        const existingIndex = researchHistory[company].findIndex(item => 
                            item.category === result.category && 
                            item.subcategory === result.subcategory && 
                            item.prompt === result.prompt
                        );
                        
                        if (existingIndex >= 0) {
                            // Update existing entry
                            researchHistory[company][existingIndex] = {
                                prompt: result.prompt,
                                result: result.result,
                                sources: result.sources,
                                category: result.category,
                                subcategory: result.subcategory,
                                promptCategory: result.category,
                                promptNumber: result.prompt_number
                            };
                        } else {
                            // Add new entry
                            researchHistory[company].push({
                                prompt: result.prompt,
                                result: result.result,
                                sources: result.sources,
                                category: result.category,
                                subcategory: result.subcategory,
                                promptCategory: result.category,
                                promptNumber: result.prompt_number
                            });
                        }
                    });
                    
                    // Sync the updated history with the backend
                    await syncResearchHistory(company);
                    
                    // Update company status
                    companyItem.querySelector('.status').textContent = `Complete - ${data.total_successful} successful, ${data.total_errors} errors`;
                    
                    // Store results for this company
                    companyResults[company] = {
                        successful: data.total_successful,
                        errors: data.total_errors
                    };
                    
                    // Update overall stats
                    overallSuccesses += data.total_successful;
                    overallErrors += data.total_errors;
                    
                    // Export results for this company in all formats
                    try {
                        // Export to Word - explicitly using the company name
                        await exportResults('word', company);
                        // Export to PDF - explicitly using the company name
                        await exportResults('pdf', company);
                        // Export to Excel - explicitly using the company name
                        await exportResults('excel', company);
                        // Export to PowerPoint - explicitly using the company name
                        await exportResults('pptx', company);
                        
                        companyItem.querySelector('.status').textContent += " (Exports complete)";
                    } catch (exportError) {
                        console.error(`Error exporting results for ${company}:`, exportError);
                        companyItem.querySelector('.status').textContent += " (Export failed: " + (exportError.message || 'Unknown error') + ")";
                    }
                    
                } catch (error) {
                    console.error(`Error processing company ${company}:`, error);
                    
                    // Update company status
                    companyItem.querySelector('.status').textContent = `Failed - ${error.message || 'Unknown error'}`;
                    
                    // Attempt to sync research history in case some results were saved
                    try {
                        syncResearchHistory(company);
                        updateHistoryList();
                    } catch (syncError) {
                        console.error('Error syncing research history:', syncError);
                    }
                }
                
                // Update completed companies count and progress bar
                completedCompanies++;
                const percentComplete = Math.floor((completedCompanies / totalCompanies) * 100);
                progressContainer.querySelector('.progress-bar').style.width = `${percentComplete}%`;
            }
            
            // Display final summary
            resultsContainer.innerHTML = `
                <div class="result">
                    <h4>Research Complete for All Companies</h4>
                    <p>Successfully completed ${overallSuccesses} research items across ${totalCompanies} companies.</p>
                    ${overallErrors > 0 ? `<p>Encountered ${overallErrors} errors during research.</p>` : ''}
                    <h5>Company Summary:</h5>
                    <ul>
                        ${Object.keys(companyResults).map(company => `
                            <li>
                                <strong>${company}</strong>: 
                                ${companyResults[company].successful} successful, 
                                ${companyResults[company].errors} errors
                            </li>
                        `).join('')}
                    </ul>
                    <p>All research results have been exported to Word, PDF, Excel, and PowerPoint formats.</p>
                </div>
            `;
        });
    });
    
    // Function to export results in different formats
    async function exportResults(format, specificCompany = null) {
        const company = specificCompany || document.getElementById('company').value;
        console.log(`Exporting for company: ${company} in format: ${format}`);
        console.log(`Research history for company:`, researchHistory[company]);
        
        if (researchHistory[company] && researchHistory[company].length > 0) {
            try {
                // Use the syncResearchHistory function to sync with backend
                await syncResearchHistory(company);
                console.log('Research history synced successfully');
                
                // Now open the export URL
                const url = `/export/${company}/${format}`;
                console.log(`Opening URL: ${url}`);
                window.open(url, '_blank');
            } catch (error) {
                console.error('Error during export process:', error);
                alert(`Export failed: ${error.message || 'Unknown error'}`);
            }
        } else {
            alert('No research results to export.');
        }
    }
    
    // Function to sync research history with backend
    async function syncResearchHistory(company) {
        try {
            // Make sure we have the company in the research history
            if (!researchHistory[company]) {
                researchHistory[company] = [];
            }
            
            // Ensure all entries have both category and promptCategory fields for compatibility
            researchHistory[company].forEach(item => {
                if (item.category && !item.promptCategory) {
                    item.promptCategory = item.category;
                } else if (item.promptCategory && !item.category) {
                    item.category = item.promptCategory;
                }
            });
            
            console.log(`Syncing ${researchHistory[company].length} research entries for ${company}`);
            
            const response = await fetch('/sync_research_history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    company: company,
                    history: researchHistory[company] || []
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                console.error('Error syncing research history:', errorData);
                throw new Error(errorData.error || 'Failed to sync research history');
            }
            
            console.log('Research history synced successfully');
            return true;
        } catch (error) {
            console.error('Error syncing research history:', error);
            throw error;
        }
    }
    
    // Function to update history list
    function updateHistoryList() {
        const company = document.getElementById('company').value;
        const historyList = document.getElementById('history-list');
        
        if (researchHistory[company] && researchHistory[company].length > 0) {
            let html = '<ul class="history-items">';
            
            // Group research results by category and subcategory for better organization
            const groupedResults = {};
            
            researchHistory[company].forEach((item, index) => {
                const category = item.category || item.promptCategory || 'Unknown';
                const subcategory = item.subcategory || 'Unknown';
                const key = `${category}|${subcategory}`;
                
                if (!groupedResults[key]) {
                    groupedResults[key] = [];
                }
                
                groupedResults[key].push({
                    index: index,
                    item: item
                });
            });
            
            // Display grouped results
            Object.keys(groupedResults).sort().forEach(key => {
                const [category, subcategory] = key.split('|');
                
                html += `<li class="category-header"><strong>${category} - ${subcategory}</strong></li>`;
                
                groupedResults[key].forEach(entry => {
                    const promptNumber = entry.item.promptNumber || 'Unknown';
                    html += `
                        <li>
                            <a href="#" class="history-item" data-index="${entry.index}">
                                Prompt #${promptNumber}
                            </a>
                        </li>
                    `;
                });
            });
            
            html += '</ul>';
            historyList.innerHTML = html;
            
            // Add event listeners to history items
            document.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const index = parseInt(this.getAttribute('data-index'));
                    const historyItem = researchHistory[company][index];
                    
                    // Display the selected research result
                    displayResults({
                        company: company,
                        prompt: historyItem.prompt,
                        result: historyItem.result,
                        sources: historyItem.sources,
                        category: historyItem.category || historyItem.promptCategory,
                        subcategory: historyItem.subcategory
                    });
                });
            });
        } else {
            historyList.innerHTML = '<p>No research conducted yet.</p>';
        }
    }
    
    // Function to display results
    function displayResults(data) {
        const resultsContainer = document.getElementById('results-container');
        
        // Format category and subcategory information if available
        let categoryInfo = '';
        if (data.category && data.subcategory) {
            categoryInfo = `<h4>Category: ${data.category} - ${data.subcategory}</h4>`;
        }
        
        // Format sources
        let sourcesHtml = '';
        if (data.sources && data.sources.length > 0) {
            sourcesHtml = '<h4>Sources</h4><ol>';
            data.sources.forEach(source => {
                sourcesHtml += `<li>${source}</li>`;
            });
            sourcesHtml += '</ol>';
        }
        
        // Format result with markdown-like syntax
        let formattedResult = data.result;
        
        // Display results
        resultsContainer.innerHTML = `
            <div class="result">
                <h4>Company: ${data.company}</h4>
                ${categoryInfo}
                <div class="prompt">
                    <h5>Prompt:</h5>
                    <p>${data.prompt}</p>
                </div>
                <div class="response">
                    <h5>Response:</h5>
                    <div class="response-content">${formattedResult}</div>
                </div>
                <div class="sources">
                    ${sourcesHtml}
                </div>
            </div>
        `;
    }
</script>
{% endblock %}
